<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Thời gian biểu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
  </head>
  <body>
    <style>
        body {
            font-family: Calibri;
        }
        #content {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto;
            width: 100vw;
            height: 100vh;
        }
        tr {
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            padding: 0px 0px 0px 0px;
            margin: 0px 0px 0px 0px;
            line-height: 100%;
        }
        th {
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            padding: 0px 0px 0px 0px;
            margin: 0px 0px 0px 0px;
            
        }
        td {
            font-size: 49pt;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            padding: 0px 0px 0px 0px;
            margin: 0px 0px 0px 0px;
        }
    </style>
        <div id="content">
            <div id="inputform" style="width: 24rem;">
                <div class="mb-2">
                    <label for="giobd" class="form-label">Giờ bắt đầu</label>
                    <input type="text" class="form-control" id="giobd">
                </div>
                <div class="mb-2">
                    <label for="kc1" class="form-label">Khoảng cách 1</label>
                    <input type="text" class="form-control" id="kc1">
                </div>
                <div class="mb-2">
                    <label for="kc2" class="form-label">Khoảng cách 2</label>
                    <input type="text" class="form-control" id="kc2">
                </div>
                <div class="mb-2">
                    <label for="kc3" class="form-label">Khoảng cách 3</label>
                    <input type="text" class="form-control" id="kc3">
                </div>
                <div class="mb-3">
                    <label for="kc4" class="form-label">Khoảng cách 4</label>
                    <input type="text" class="form-control" id="kc4">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="setClock()">Xong</button>
            </div>
            <table class="table" id="clock" style="width: 24rem; height: 18rem;" hidden>
                <tbody>
                    <tr>
                        <td style="color: blue;  font-size: 35pt">B-REST</th>
                        <td style="color: rgb(51, 204, 51); font-size: 35pt;">A-REST</th>
                    </tr>
                    <tr>
                        <td id="BREST" style="color: blue;"></td>
                        <td id="AREST" style="color: rgb(51, 204, 51);"></td>
                    </tr>
                    <tr>
                        <td style="color: red;  font-size: 35pt">B-WORK</th>
                        <td style="color: rgb(255, 153, 0);  font-size: 35pt">A-WORK</th>
                    </tr>
                    <tr>
                        <td id="BWORK" style="color: red;"></td>
                        <td id="AWORK" style="color: rgb(255, 153, 0);"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    <script>
        const BREST = document.getElementById("BREST");
        const AREST = document.getElementById("AREST");
        const BWORK = document.getElementById("BWORK");
        const AWORK = document.getElementById("AWORK");

        let it = null;
        let base = 0;
        let khoangcach = [0, 0, 0, 0];


        // if (localStorage.getItem("settings")) {
        //     const settings = JSON.parse(localStorage.getItem("settings"));
        //     base = settings.base;
        //     khoangcach = [...settings.khoangcach];
        //     showClock();
        // }
        
        function getSecondsInDay() {
            const date = new Date(Date.now());
            return date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds();
        }

        function resetClock() {
            if (it) clearInterval(it);
            it = null;
            const minute = (base / 60) % 60;
            const hour = Math.floor(base / 3600);
            [1, 2, 3, 4].forEach((v, idx) => document.getElementById(`kc${v}`).value = (idx ? khoangcach[idx] - khoangcach[idx - 1] : khoangcach[idx]) / 60);
            document.getElementById("giobd").value = [hour, minute].join(":");

            localStorage.clear();
            document.getElementById("clock").setAttribute('hidden', '');
            document.getElementById("inputform").removeAttribute('hidden');
        }

        function setClock() {
            
            const [hour, minute] = document.getElementById("giobd").value.split(":").map(v => parseInt(v));
            base = hour * 3600 + minute * 60;
            [1, 2, 3, 4].forEach((v, idx) => khoangcach[idx] = 60 * parseInt(document.getElementById(`kc${v}`).value));
            // [1, 2, 3, 4].forEach((v, idx) => {
            //     khoangcach[idx] = (idx ? khoangcach[idx - 1] : 0) + 60 * parseInt(document.getElementById(`kc${v}`).value);
            // });
            
            // localStorage.setItem("settings", JSON.stringify({ base, khoangcach }));
            showClock();
        }


        function showClock() {
            if (it) clearInterval(it);
            it = setInterval(updateClock, 1000);
            updateClock();
            document.getElementById("inputform").setAttribute('hidden', '');
            document.getElementById("clock").removeAttribute('hidden');
        }

        function updateClock() {
            const period = khoangcach[0] + khoangcach[1] + khoangcach[2] + khoangcach[3];
            const normalize = v => (period + v % period) % period;
            const offset = normalize(getSecondsInDay() - base);
            [BREST, AREST, BWORK, AWORK].forEach(v => v.innerText = "---");
            const minuteStr = value => `${(value / 60).toFixed(2)}`;
            const times = [
                normalize(-offset + khoangcach[0] + khoangcach[1]),
                normalize(-offset + khoangcach[0] + khoangcach[1] + khoangcach[2]),
                normalize(-offset + khoangcach[0] + khoangcach[1] + khoangcach[2] + khoangcach[3]),
                normalize(-offset + khoangcach[0])
            ];
            if (times[0] < times[2])
                AREST.innerText = minuteStr(times[0]);
            else
                AWORK.innerText = minuteStr(times[2]);
            
            if (times[1] < times[3])
                BREST.innerText = minuteStr(times[1]);
            else
                BWORK.innerText = minuteStr(times[3]);
        }

    </script>
  </body>
</html>
